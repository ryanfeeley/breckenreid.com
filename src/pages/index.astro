---
import Layout from '../layouts/Layout.astro';
import PostCard from '../components/PostCard.astro';
import { getCollection } from 'astro:content';

// Fetch all collections
const allPages = await getCollection('pages');
const allNews = await getCollection('news');
const allWork = await getCollection('work');
const allSold = await getCollection('sold');

// Combine for filtering
const allContent = [...allPages, ...allNews, ...allWork, ...allSold];

// Filter for pagetype containing 'main' and sort by number
const posts = allContent.filter(item => {
    return item.data.pagetype && item.data.pagetype.includes('main');
}).sort((a, b) => {
    const numA = a.data.number || 9999;
    const numB = b.data.number || 9999;
    return numA - numB;
});

// Get index-page metadata (from pages collection)
const indexPage = allPages.find(p => p.slug === 'index');
const title = indexPage?.data.title || 'Clay';
const description = indexPage?.data.description;

let postCounter = 0;
---

<Layout title={title} description={description}>
    <div class="post-feed">
        {posts.map((post) => {
            postCounter++;
            // Calculate slug. If it's from 'pages', slug is just slug (or flattened).
            // content/pages/about.md -> slug 'about'.
            // content/work/work-1.md -> slug 'work-1'? No, in config.ts, work collection.
            // But legacy mapped work/work-1.md -> /work/work-1
            // My [...slug].astro will handle mapping.
            // Here I need to generate the same link.

            let slug = post.slug;
            if (post.collection === 'work') slug = `work/${post.slug}`;
            if (post.collection === 'news') slug = `news/${post.slug}`;
            if (post.collection === 'sold') slug = `sold/${post.slug}`;
            // Pages collection: 'about' -> 'about'.

            // Wait, legacy slug split logic:
            // src/pages/about/index.md -> /about.
            // content/work/work-1.md -> /work/work-1.

            return (
                <PostCard
                    count={postCounter}
                    post={post}
                    slug={slug}
                />
            );
        })}
    </div>
</Layout>
